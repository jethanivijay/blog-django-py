#!/bin/bash
set -e

# 1. Define location of hooks
HOOKS_DIR=$(dirname "$0")/../action_hooks

# 2. Function to run hooks
run_hook() {
    if [ -x "$HOOKS_DIR/$1" ]; then
        echo "---> Running $1 hook..."
        "$HOOKS_DIR/$1"
    fi
}

# 3. Ensure we are in the correct directory
cd ./s2i

# --- PRE_RUN HOOK ---
run_hook "pre_run"

# 4. Start the Application
echo "---> Starting application..."

# A: If Gunicorn is installed, use it
if command -v gunicorn > /dev/null 2>&1; then
    # Auto-detect wsgi.py
    if [ -z "$APP_MODULE" ]; then
        if [ -f wsgi.py ]; then
            APP_MODULE="wsgi"
        else
            WSGI_FILE=$(find . -maxdepth 2 -type f -name 'wsgi.py' | head -n 1)
            if [ -n "$WSGI_FILE" ]; then
                APP_MODULE=$(echo "$WSGI_FILE" | cut -c 3- | sed 's|/|.|g' | sed 's|.py||')
            fi
        fi
    fi

    if [ -n "$APP_MODULE" ]; then
        echo "---> Starting Gunicorn with module: $APP_MODULE"
        exec gunicorn "$APP_MODULE:application" \
             --bind 0.0.0.0:8080 \
             --workers 3 \
             --access-logfile - \
             --error-logfile -
    else
        echo "ERROR: Gunicorn found, but no 'wsgi.py' detected."
        echo "Files seen: $(ls -m)"
        exit 1
    fi

# B: Fallback to Django Development Server
elif [ -f manage.py ]; then
    echo "WARNING: Gunicorn not found. Starting Django development server."
    exec python manage.py runserver 0.0.0.0:8080
else
    echo "ERROR: Could not find 'gunicorn' or 'manage.py'."
    echo "CRITICAL: The directory /opt/app-root/src appears to be empty."
    echo "Check if a Volume Mount is overwriting your code."
    exit 1
fi
